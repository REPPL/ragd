# F-207: Shell Script Export

## Overview

**Milestone**: v1.4
**Priority**: P2
**Depends On**: [F-201](./F-201-workflow-automation.md) (Workflow Automation)
**Research**: [State-of-the-Art Automation Scripts](../../research/state-of-the-art-automation-scripts.md)

## Problem Statement

Users need to:
- Run ragd tasks outside of the ragd environment
- Schedule tasks via cron/launchd
- Share workflows with colleagues who don't have ragd installed
- Integrate ragd into existing shell pipelines

YAML task definitions (F-201) work within ragd but can't be run standalone.

## Design Approach

### Export to Self-Documenting Shell Scripts

Generate bash scripts with:
- Explanatory header comments
- Step-by-step comments explaining each command
- Dry-run support built-in
- Error handling
- Progress feedback

### Example Output

```bash
#!/bin/bash
# Weekly Research Analysis Script
# Generated by ragd on 2025-01-15
# Source: ~/.ragd/tasks/weekly-research-analysis.yaml
#
# This script:
#   1. Indexes all new PDFs in ~/Research/Papers/incoming/
#   2. Tags documents as "weekly-intake"
#   3. Generates summaries using Llama 3.2
#   4. Saves reports to ~/Research/reports/
#
# Usage:
#   ./weekly-research.sh              # Run normally
#   ./weekly-research.sh --dry-run    # Preview without changes
#   ./weekly-research.sh --help       # Show this help
#
# Requirements:
#   - ragd >= 0.9.0
#   - Ollama running with llama3.2 model
#

set -euo pipefail  # Exit on error, undefined vars, pipe failures

# Configuration (edit these if needed)
INPUT_PATH="$HOME/Research/Papers/incoming"
OUTPUT_PATH="$HOME/Research/reports"
MODEL="llama3.2"

# Parse arguments
DRY_RUN=false
while [[ $# -gt 0 ]]; do
    case $1 in
        --dry-run) DRY_RUN=true; shift ;;
        --help) head -20 "$0" | tail -18; exit 0 ;;
        *) echo "Unknown option: $1"; exit 1 ;;
    esac
done

# Helper function for dry-run mode
run_cmd() {
    if $DRY_RUN; then
        echo "[DRY-RUN] Would run: $*"
    else
        "$@"
    fi
}

echo "=== Weekly Research Analysis ==="
echo "Started: $(date)"
echo ""

# Step 1: Index new documents
# Adds all PDFs to your knowledge base with automatic tagging
echo "Step 1/3: Indexing new documents..."
run_cmd ragd index "$INPUT_PATH" \
    --recursive \
    --tags weekly-intake,auto-indexed

# Step 2: Generate summaries
# Creates summaries using the configured LLM
echo "Step 2/3: Generating summaries..."
run_cmd ragd ask "Summarise the key findings and methodology" \
    --model "$MODEL" \
    --output "$OUTPUT_PATH/$(date +%Y-%m-%d)-summaries.md"

# Step 3: Report completion
echo ""
echo "=== Complete ==="
echo "Finished: $(date)"
echo "Output: $OUTPUT_PATH"
```

### Command Structure

```
ragd script export <name>              # Export to stdout
ragd script export <name> -o file.sh   # Export to file
ragd script export <name> --cron       # Output crontab entry
ragd script export <name> --launchd    # Output launchd plist
```

## Implementation Tasks

- [ ] Create `src/ragd/task_export.py` module
- [ ] Implement shell script template engine
- [ ] Generate explanatory comments for each step
- [ ] Add dry-run support to generated scripts
- [ ] Add argument parsing to generated scripts
- [ ] Add error handling with helpful messages
- [ ] Implement `--cron` output for crontab integration
- [ ] Implement `--launchd` output for macOS scheduling
- [ ] Add script validation before export
- [ ] Test generated scripts on bash/zsh

## Success Criteria

- [ ] Generated scripts are valid bash (passes shellcheck)
- [ ] Non-expert users can understand what scripts do from comments
- [ ] `--dry-run` in generated scripts accurately previews actions
- [ ] Scripts work on Linux and macOS
- [ ] Cron integration works with `crontab -e`
- [ ] Documentation includes scheduling examples

## Dependencies

- [F-201](./F-201-workflow-automation.md) - Task definition schema

## Technical Notes

### Script Template Structure

```python
SCRIPT_TEMPLATE = '''#!/bin/bash
# {name}
# Generated by ragd on {date}
# Source: {source_file}
#
# This script:
{description_bullets}
#
# Usage:
#   ./{filename}              # Run normally
#   ./{filename} --dry-run    # Preview without changes
#   ./{filename} --help       # Show this help
#
# Requirements:
{requirements}
#

set -euo pipefail

{configuration_section}

{argument_parsing}

{helper_functions}

{task_steps}

echo ""
echo "=== Complete ==="
echo "Finished: $(date)"
'''
```

### Cron Output Format

```
ragd script export weekly-analysis --cron
# Output:
# Weekly Research Analysis
# Run every Monday at 9am
0 9 * * 1 /usr/local/bin/ragd script run weekly-analysis >> ~/.ragd/logs/weekly-analysis.log 2>&1
```

### Launchd Output Format

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>ai.ragd.weekly-analysis</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/ragd</string>
        <string>script</string>
        <string>run</string>
        <string>weekly-analysis</string>
    </array>
    <key>StartCalendarInterval</key>
    <dict>
        <key>Weekday</key>
        <integer>1</integer>
        <key>Hour</key>
        <integer>9</integer>
    </dict>
</dict>
</plist>
```

## Related Documentation

- [F-201](./F-201-workflow-automation.md) - Workflow Automation foundation
- [F-206](./F-206-interactive-script-wizard.md) - Interactive Script Wizard
- [State-of-the-Art Automation Scripts](../../research/state-of-the-art-automation-scripts.md)

---

**Status**: Planned
