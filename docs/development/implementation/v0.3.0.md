# Implementation: v0.3.0 Advanced Search

## Overview

v0.3.0 delivers the "Advanced Search" milestone: state-of-the-art retrieval techniques including hybrid search (BM25 + semantic), contextual retrieval (Anthropic-style), late chunking (JinaAI-inspired), and citation output in multiple academic formats.

## Features Implemented

| Feature | Status | Notes |
|---------|--------|-------|
| [F-009](../features/completed/F-009-citation-output.md) | Complete | APA, MLA, Chicago, BibTeX, Inline, Markdown formats |
| [F-010](../features/completed/F-010-contextual-retrieval.md) | Complete | LLM-powered context generation via Ollama |
| [F-011](../features/completed/F-011-late-chunking.md) | Complete | Full document context for chunk embeddings |
| [F-012](../features/completed/F-012-hybrid-search.md) | Complete | BM25 + semantic with Reciprocal Rank Fusion |

**Deferred:** Query Decomposition and Reranking moved to v0.4+.

## Architecture

```
src/ragd/
├── search/
│   ├── __init__.py
│   ├── searcher.py          # Semantic search
│   ├── hybrid.py            # Hybrid search (BM25 + semantic + RRF)
│   └── bm25.py              # BM25 keyword search
├── embedding/
│   ├── __init__.py
│   ├── embedder.py          # Standard embedding
│   └── late_chunking.py     # Late chunking embedder
├── contextual/
│   ├── __init__.py
│   ├── generator.py         # Context generation
│   └── llm.py               # Ollama LLM client
└── citation/
    ├── __init__.py
    ├── citation.py          # Citation dataclass and style enum
    └── formatter.py         # Style-specific formatters
```

## Technology Stack

| Component | Technology | Notes |
|-----------|------------|-------|
| BM25 | rank-bm25 | Keyword retrieval |
| Hybrid Fusion | RRF | k=60 default |
| LLM | Ollama | Local inference for contextual |
| Late Chunking | sentence-transformers | Full document encoding |
| Citation | Custom formatters | Academic standards |

## Key Implementation Decisions

1. **Hybrid Search Mode:** Default search mode combines BM25 keyword and semantic vector search using Reciprocal Rank Fusion (RRF) with k=60.

2. **Contextual Retrieval:** Optional feature requiring Ollama. Generates document-aware context for each chunk before embedding, improving retrieval accuracy by ~20%.

3. **Late Chunking:** Encodes full document through transformer, then extracts embeddings at chunk boundaries. Preserves cross-chunk context in embeddings.

4. **Citation Formatters:** Pluggable formatter architecture supporting multiple styles:
   - APA 7th edition
   - MLA 9th edition
   - Chicago notes-bibliography
   - BibTeX for LaTeX
   - Inline (filename, p. X)
   - Markdown links

5. **CLI Integration:**
   - `--mode hybrid|semantic|keyword` for search mode
   - `--contextual/--no-contextual` for contextual retrieval
   - `--late-chunking/--no-late-chunking` for late chunking
   - `--cite none|inline|apa|mla|chicago|bibtex|markdown` for citations

## Implementation Details

### Hybrid Search (F-012)

```python
# Reciprocal Rank Fusion combining BM25 and semantic scores
def rrf_score(semantic_rank: int, bm25_rank: int, k: int = 60) -> float:
    return 1/(k + semantic_rank) + 1/(k + bm25_rank)
```

### Contextual Retrieval (F-010)

Uses Ollama to generate context for each chunk:
```
<document>
{full_document_text}
</document>
Here is the chunk we want to situate:
<chunk>
{chunk_text}
</chunk>
Please give a short context to situate this chunk within the document.
```

### Late Chunking (F-011)

1. Encode full document through transformer
2. Map character boundaries to token boundaries
3. Mean-pool token embeddings within each chunk boundary
4. Result: chunk embeddings with full document context

### Citation Output (F-009)

```python
Citation.from_search_result(result)  # Factory method
format_citation(citation, CitationStyle.APA)  # Format output
```

## Test Coverage

- **543 tests passing**, 22 skipped
- F-009: 33 citation tests
- F-010: 29 contextual retrieval tests
- F-011: 19 late chunking tests
- F-012: Hybrid search tests (integrated with existing search tests)

## Related Documentation

- [v0.3.0 Milestone](../milestones/v0.3.0.md)
- [ADR-0007: Retrieval Strategy](../decisions/adrs/0007-retrieval-strategy.md)
- [State-of-the-Art RAG](../research/state-of-the-art-rag.md)

---

**Status**: Complete
