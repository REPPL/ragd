# v0.7.0 Implementation Record

## Overview

Privacy and security release providing database encryption, session management, secure deletion, PII detection, and chat citation improvements.

## Features Implemented

### F-065: Chat Citation Display

**Modules:**
- `src/ragd/chat/message.py` - CitedAnswer dataclass
- `src/ragd/ui/cli/commands.py` - Citation display in ask/chat

**Key Components:**
- `CitedAnswer.format_with_citations()` - Format citations in numbered/inline/footnote style
- `--cite` CLI flag for ask and chat commands
- Configurable default citation mode via `config.chat.default_cite_mode`

### F-066: Configurable Chat Prompts

**Modules:**
- `src/ragd/config.py` - ChatPromptsConfig, ChatConfig
- `src/ragd/chat/prompts.py` - Citation instruction injection
- `src/ragd/chat/session.py` - Config integration

**Key Components:**
- `ChatPromptsConfig` - Customisable prompt elements
- `ChatConfig` - Chat-specific settings (temperature, max_tokens, etc.)
- `PromptTemplate.with_citation_instruction()` - Inject custom citation instructions

### F-015: Database Encryption

**Modules:**
- `src/ragd/security/crypto.py` - Argon2id key derivation
- `src/ragd/security/keystore.py` - Master key management
- `src/ragd/security/encrypted_store.py` - SQLCipher wrapper

**Key Components:**
- `KeyDerivation` - Argon2id with 64MB memory, 3 iterations, 4 parallel
- `KeyStore` - Secure key storage and retrieval
- `EncryptedStore` - AES-256-GCM encryption via SQLCipher

### F-016: Session Management

**Modules:**
- `src/ragd/security/session.py` - Session state machine

**Key Components:**
- `SessionState` enum (LOCKED, ACTIVE, IDLE)
- `SessionManager` - State transitions, inactivity timer
- Auto-lock after configurable timeout
- Failed attempt tracking and lockout
- Memory clearing on lock (`ctypes.memset`)

### F-017: Secure Deletion

**Modules:**
- `src/ragd/security/deletion.py` - Secure deletion with audit

**Key Components:**
- `DeletionLevel` enum (STANDARD, SECURE, CRYPTOGRAPHIC)
- `Overwriter` - Secure file/memory overwriting
- `SecureDeleter` - Coordinated deletion across stores
- `DeletionAuditLog` - Tamper-evident audit trail

### F-023: PII Detection

**Modules:**
- `src/ragd/privacy/pii.py` - PII detection engines

**Key Components:**
- `PIIEngine` enum (PRESIDIO, SPACY, REGEX, HYBRID)
- `PIIEntityType` enum - 11 PII categories
- `RegexDetector` - Pattern matching for emails, phones, SSN, credit cards
- `PresidioDetector` - Microsoft Presidio integration (optional)
- `SpacyDetector` - NER fallback (optional)
- `PIIDetector` - Orchestrates detection engines
- `redact_pii()` - Replace PII with redaction characters

## CLI Commands

### New Commands

```bash
# Session Management
ragd unlock [--extend]           # Unlock encrypted database
ragd lock                        # Lock session immediately
ragd session status              # View session state

# Password Management
ragd password change             # Change encryption password
ragd password reset --confirm-data-loss  # Reset encryption (deletes data)

# Secure Deletion
ragd delete <doc_ids> [--secure] [--purge] [--force]
ragd delete audit [--all] [-n LIMIT]

# Chat Citations
ragd ask "query" --cite <mode>   # none, numbered, inline
ragd chat --cite <mode>          # Interactive chat with citations
```

### Configuration

```yaml
# Security settings
security:
  encryption:
    enabled: true
    algorithm: AES-256-GCM
    kdf: argon2id
  session:
    auto_lock_minutes: 5
    failed_attempts_lockout: 5
  deletion:
    default_level: standard
    audit_log: true

# Chat settings
chat:
  temperature: 0.7
  max_tokens: 1024
  default_cite_mode: numbered
  prompts:
    citation_instruction: "Always cite your sources..."

# PII settings
pii:
  enabled: false
  detection:
    engine: hybrid
    confidence_threshold: 0.7
```

## Architecture

### New Module: security/

```
src/ragd/security/
├── __init__.py
├── crypto.py          # Argon2id key derivation
├── keystore.py        # Master key management
├── encrypted_store.py # SQLCipher wrapper
├── session.py         # Session state machine
└── deletion.py        # Secure deletion with audit
```

### New Module: privacy/

```
src/ragd/privacy/
├── __init__.py
└── pii.py             # PII detection engines
```

### Config Additions

```python
# src/ragd/config.py

class ChatPromptsConfig(BaseSettings):
    citation_instruction: str = "Always cite your sources..."

class ChatConfig(BaseSettings):
    temperature: float = 0.7
    max_tokens: int = 1024
    default_cite_mode: str = "numbered"
    prompts: ChatPromptsConfig = ChatPromptsConfig()
```

## Testing

**Test Coverage:**
- Security tests: `tests/security/` (126 tests)
- Privacy tests: `tests/privacy/` (27 tests)
- Chat tests: `tests/test_chat.py` (updated)

**Total: 1022 passed, 42 skipped**

## Files Changed

| File | Purpose |
|------|---------|
| `src/ragd/security/crypto.py` | Argon2id key derivation |
| `src/ragd/security/keystore.py` | Key storage |
| `src/ragd/security/encrypted_store.py` | SQLCipher wrapper |
| `src/ragd/security/session.py` | Session management |
| `src/ragd/security/deletion.py` | Secure deletion |
| `src/ragd/privacy/pii.py` | PII detection |
| `src/ragd/config.py` | Chat/security config |
| `src/ragd/chat/prompts.py` | Citation injection |
| `src/ragd/chat/message.py` | CitedAnswer |
| `src/ragd/chat/session.py` | Config integration |
| `src/ragd/ui/cli/commands.py` | CLI commands |
| `src/ragd/ui/cli/security.py` | Security CLI |
| `src/ragd/ui/cli/deletion.py` | Deletion CLI |
| `src/ragd/cli.py` | Command registration |

## Dependencies Added

```toml
# pyproject.toml [project.optional-dependencies]
encryption = [
    "pysqlcipher3>=1.2.0",
    "argon2-cffi>=23.1.0",
]
privacy = [
    "presidio-analyzer>=2.2.0",
    "spacy>=3.7.0",
]
```

---

**Status**: Complete
