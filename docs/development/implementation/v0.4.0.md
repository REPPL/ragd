# Implementation: v0.4.0 Multi-Modal

## Overview

v0.4.0 delivers the "Multi-Modal" milestone: vision embeddings and image retrieval capabilities that extend ragd beyond text-only RAG. Users can now search for images by description, find similar images, and extract visual content from documents.

## Features Implemented

| Feature | Status | Notes |
|---------|--------|-------|
| [F-019](../features/completed/F-019-multi-modal-support.md) | Complete | Vision embeddings, image extraction, multi-modal search |

## Architecture

```
src/ragd/
├── vision/                     # NEW - Vision infrastructure
│   ├── __init__.py             # Module exports
│   ├── embedder.py             # VisionEmbedder, ColPaliEmbedder
│   ├── image.py                # Image extraction, metadata
│   └── pipeline.py             # Indexing pipelines
├── search/
│   ├── multimodal.py           # NEW - Multi-modal search
│   └── ...                     # Existing search modules
├── storage/
│   ├── images.py               # NEW - ImageStore, ImageRecord
│   └── ...                     # Existing storage modules
└── config.py                   # Extended with MultiModalConfig
```

## Technology Stack

| Component | Technology | Notes |
|-----------|------------|-------|
| Vision Embeddings | ColPali/ColQwen2 | 128-dim vision vectors |
| Image Extraction | PyMuPDF (fitz) | PDF image extraction with size filtering |
| Image Storage | ChromaDB | Separate collection for vision embeddings |
| OCR (optional) | PaddleOCR/EasyOCR | Text extraction from images |

## Key Implementation Decisions

1. **Separate Vision Collection:** Vision embeddings (128-dim) stored separately from text embeddings (384-dim) due to different dimensionalities. This enables efficient similarity search within each modality.

2. **ColPali as Primary Vision Model:** Chose ColPali/ColQwen2 for document-focused vision understanding. These models excel at understanding document pages, diagrams, and charts compared to general-purpose vision models.

3. **Content-Hash Deduplication:** Images are deduplicated using content hashes to avoid re-embedding identical images across documents.

4. **Disabled by Default:** Multi-modal features require ColPali dependencies which are substantial. Feature is opt-in via configuration to keep base install lightweight.

5. **Size Filtering:** Small images (< 100px default) are skipped during extraction to avoid icons, bullets, and other non-informative visual elements.

## Implementation Details

### Vision Embeddings (ColPaliEmbedder)

```python
from ragd.vision import ColPaliEmbedder, create_vision_embedder

embedder = create_vision_embedder()  # Factory function
embeddings = embedder.embed_images([image1, image2])  # Batch embedding
query_embedding = embedder.embed_text("architecture diagram")  # Text query
```

### Image Extraction

```python
from ragd.vision import extract_images_from_pdf, ExtractedImage

images: list[ExtractedImage] = extract_images_from_pdf(
    pdf_path="document.pdf",
    min_width=100,
    min_height=100
)
# Each image has: data, format, page_number, metadata
```

### Multi-Modal Search

```python
from ragd.search import MultiModalSearcher

searcher = MultiModalSearcher(text_store, image_store, vision_embedder)

# Text-to-image search
results = searcher.search_images("flowchart showing authentication")

# Image-to-image similarity
similar = searcher.search_similar_images(image_bytes)
```

### Configuration

```yaml
multi_modal:
  enabled: true
  vision_model: colpali-v1.0  # or colqwen2-v1.0
  extract_images: true
  min_image_width: 100
  min_image_height: 100
  generate_thumbnails: false
```

## Test Coverage

- **73 new tests** for multi-modal functionality
- `test_vision.py`: Vision embedder tests
- `test_vision_pipeline.py`: Indexing pipeline tests
- `test_image_storage.py`: Image storage tests
- `test_multimodal_search.py`: Search integration tests

## Files Changed

| File | Change Type | Lines |
|------|-------------|-------|
| `src/ragd/vision/__init__.py` | New | 54 |
| `src/ragd/vision/embedder.py` | New | 345 |
| `src/ragd/vision/image.py` | New | 444 |
| `src/ragd/vision/pipeline.py` | New | 450 |
| `src/ragd/search/multimodal.py` | New | 343 |
| `src/ragd/storage/images.py` | New | 455 |
| `src/ragd/config.py` | Modified | +22 |
| `src/ragd/ingestion/pipeline.py` | Modified | +29 |
| Tests (4 files) | New | 1,455 |
| **Total** | | **3,619** |

## Related Documentation

- [v0.4.0 Milestone](../milestones/v0.4.0.md)
- [F-019: Multi-Modal Support](../features/completed/F-019-multi-modal-support.md)
- [State-of-the-Art Multi-Modal](../research/state-of-the-art-multi-modal.md)

---

**Status**: Complete
