# v0.8.2 Implementation Record

**Theme:** "Intelligence & Organisation" - Retrieval Enhancements
**Released:** 2025-12-03
**Duration:** ~2 hours

## Overview

v0.8.2 enhances retrieval quality with Cross-Encoder Reranking (F-065) and Query Decomposition (F-066). These features improve precision for complex queries without changing the indexing pipeline.

## Features Implemented

### F-065: Cross-Encoder Reranking

Post-retrieval reranking using cross-encoder models for improved precision.

**Changes:**
- Created `src/ragd/search/rerank.py` with CrossEncoderReranker class
- Lazy-loading of cross-encoder model to avoid startup cost
- Support for sentence-transformers cross-encoder models
- Configurable via RerankerConfig (model, device, batch_size, top_k)
- Graceful degradation when model unavailable
- Module-level `rerank()` convenience function

**Supported Models:**
| Model | Speed | Quality |
|-------|-------|---------|
| cross-encoder/ms-marco-MiniLM-L-6-v2 | Fast | Good (default) |
| cross-encoder/ms-marco-TinyBERT-L-2-v2 | Very fast | Acceptable |
| BAAI/bge-reranker-base | Slow | High |

### F-066: Query Decomposition

Breaking complex queries into sub-queries for comprehensive retrieval.

**Changes:**
- Created `src/ragd/search/decompose.py` with QueryDecomposer class
- Rule-based decomposition patterns:
  - Comparison: "X vs Y", "X versus Y", "compare X and Y"
  - Conjunction: "X and Y", "X also Y"
  - Multi-aspect: "X for Y and Z"
- LLM-based decomposition (optional, with fallback)
- ResultAggregator for combining results from sub-queries
- Aggregation methods: MAX, SUM, WEIGHTED
- Sub-query provenance tracking in results

**Decomposition Strategies:**
| Strategy | Description | Dependencies |
|----------|-------------|--------------|
| NONE | No decomposition | None |
| RULE_BASED | Pattern matching (default) | None |
| LLM | Local LLM decomposition | ragd.llm |

## API Examples

```python
from ragd.search import (
    rerank,
    CrossEncoderReranker,
    RerankerConfig,
    decompose_query,
    QueryDecomposer,
    DecompositionStrategy,
)

# Reranking
results = hybrid_search(query, limit=50)
reranked = rerank(query, results, top_k=10)

# With custom config
config = RerankerConfig(model_name="BAAI/bge-reranker-base")
reranker = CrossEncoderReranker(config)
reranked = reranker.rerank(query, results)

# Query decomposition
sub_queries = decompose_query("JWT vs sessions for security")
# Returns: [SubQuery(text="JWT security", ...), SubQuery(text="sessions security", ...)]

# With LLM
decomposer = QueryDecomposer(DecomposerConfig(strategy=DecompositionStrategy.LLM))
sub_queries = decomposer.decompose(complex_query)
```

## Files Changed

### New Files
- `src/ragd/search/rerank.py` - CrossEncoderReranker and helpers
- `src/ragd/search/decompose.py` - QueryDecomposer and ResultAggregator
- `tests/search/test_rerank.py` - 15 tests
- `tests/search/test_decompose.py` - 29 tests
- `docs/development/features/planned/F-065-cross-encoder-reranking.md`
- `docs/development/features/planned/F-066-query-decomposition.md`

### Modified Files
- `src/ragd/__init__.py` - Version bump to 0.8.2
- `pyproject.toml` - Version bump to 0.8.2
- `src/ragd/search/__init__.py` - New exports

## Test Coverage

- 44 new tests for rerank and decompose modules
- All 1201 tests pass (44 new + 1157 existing)
- 38 tests skipped (external dependencies)

## Dependencies

No new dependencies required. Uses existing:
- sentence-transformers (for cross-encoder)
- torch (for inference)
- re (stdlib) for pattern matching

## What's Next

v0.8.2 completes retrieval enhancements:
- **v0.8.5**: Dual-Index Architecture, Knowledge Graph

## Related Documentation

- [F-065: Cross-Encoder Reranking](../features/completed/F-065-cross-encoder-reranking.md)
- [F-066: Query Decomposition](../features/completed/F-066-query-decomposition.md)

---

**Status**: Completed
